"""
        COPYRIGHT (c) 2017 by Featuremine Corporation.
        This software has been provided pursuant to a License Agreement
        containing restrictions on its use.  This software contains
        valuable trade secrets and proprietary information of
        Featuremine Corporation and is protected by law.  It may not be
        copied or distributed in any form or medium, disclosed to third
        parties, reverse engineered or used in any manner not provided
        for in said License Agreement except with the prior written
        authorization from Featuremine Corporation.

        """

"""
@package op_tests.py
@author Maxim Trokhimtchouk
@date 17 Dec 2018
@brief File contains extractor python tests
"""

import extractor as extr
from extractor import result_as_pandas
from datetime import datetime, timedelta
import numpy as np
import pandas as pd
import os

src_dir = os.path.dirname(os.path.realpath(__file__))


def zero_to_nan(op, frame, name):
    field = op.field(frame, name)
    return op.cond(op.is_zero(field), op.nan(field), field)


def zero_to_one(op, frame, name):
    field = op.field(frame, name)
    return op.cond(op.is_zero(field),
                   op.constant((name, extr.Float64, 1.0)),
                   field)


def zero_ident(op, frame, name):
    return op.field(frame, name)


def def_data(op, transform):
    trade_file = os.path.join(src_dir, "data/test_input.csv")
    data = op.csv_play(
        trade_file,
        (("receive", extr.Time64, ""),
         ("val1", extr.Float64, ""),
         ("val2", extr.Float64, "")))
    return op.combine(
        transform(op, data, "val1"), tuple(),
        transform(op, data, "val2"), tuple())


def def_avg_data(op, transform):
    trade_file = os.path.join(src_dir, "data/averages_input.csv")
    data = op.csv_play(
        trade_file,
        (("receive", extr.Time64, ""),
         ("val1", extr.Float64, ""),
         ("w1", extr.Float64, ""),
         ("w2", extr.Float64, "")))
    return op.combine(
        transform(op, data, "val1"), tuple(), op.field(data, "w1"), tuple(), op.field(data, "w2"), tuple())


def run_test(data, transform, test):
    graph = extr.system.comp_graph()
    op = graph.features

    run = test(op, data(op, transform))
    aggr = op.accumulate(run)
    graph.stream_ctx().run_to(timedelta(microseconds=10))
    as_pd = result_as_pandas(aggr)
    return as_pd


def elapsed_on_tick(op, data):
    return op.elapsed(op.field(data, "val1"), op.field(data, "val2"))


def elapsed_on_time(op, data):
    bar_period = timedelta(microseconds=2)
    close = op.timer(bar_period)
    return op.elapsed(op.field(data, "val1"), close)


def sum_tw_on_tick(op, data):
    return op.sum_tw(data, op.field(data, "val2"))


def sum_tw_on_time(op, data):
    bar_period = timedelta(microseconds=2)
    close = op.timer(bar_period)
    return op.sum_tw(data, close)


def unique(op, data):
    return op.unique(data)


def delta_on_tick(op, data):
    return op.delta(data, op.field(data, "val2"))


def delta_on_time(op, data):
    bar_period = timedelta(microseconds=2)
    close = op.timer(bar_period)
    return op.delta(data, close)


def cumulative(op, data):
    return op.cumulative(data)


def sma_tick_mw(op, data):
    return op.sma_tick_mw(op.field(data, "val1"), 10)


def sma_time_mw(op, data):
    return op.sma_time_mw(op.field(data, "val1"), timedelta(microseconds=2))


def stdev_tick_mw(op, data):
    return op.stdev_tick_mw(op.field(data, "val1"), 10)


def stdev_time_mw(op, data):
    return op.stdev_time_mw(op.field(data, "val1"), timedelta(microseconds=2))


def median_tick_mw(op, data):
    return op.median_tick_mw(op.field(data, "val1"), 10)


def median_time_mw(op, data):
    return op.median_time_mw(op.field(data, "val1"), timedelta(microseconds=2))


def percentile_tick_mw(op, data):
    return op.percentile_tick_mw(op.field(data, "val1"), 10, 0, 50, 95, 100)


def percentile_time_mw(op, data):
    return op.percentile_time_mw(op.field(data, "val1"), timedelta(microseconds=2), 0, 50, 95, 100)


def ema_exp(op, data):
    return op.ema_exp(op.field(data, "val1"), op.field(data, "val1"), timedelta(microseconds=2))


def stdev_exp(op, data):
    return op.stdev_exp(op.field(data, "val1"), op.field(data, "val1"), timedelta(microseconds=2))


def ar(op, data):
    unique_data = op.unique(op.combine(op.field(data, "w1"), tuple(), op.field(data, "w2"), tuple()))
    return op.ar(op.field(data, "val1"), op.field(unique_data, "w1"), op.field(unique_data, "w2"))


if __name__ == "__main__":


    np.testing.assert_array_equal(run_test(def_data, zero_ident, elapsed_on_tick)['val1'].astype(np.int64),
                                  np.array([9223372036854775807, 200, 300, 400, 500, 600, 700, 800, 900, 1000]))
    np.testing.assert_array_equal(run_test(def_data, zero_ident, elapsed_on_time)['val1'].astype(np.int64),
                                  np.array([9223372036854775807, 2000, 2000, 2000]))
    np.testing.assert_array_equal(run_test(def_data, zero_to_one, elapsed_on_tick)['val1'].astype(np.int64),
                                  np.array([9223372036854775807, 200, 300, 400, 500, 600, 700, 800, 900, 1000]))
    np.testing.assert_array_equal(run_test(def_data, zero_to_one, elapsed_on_time)['val1'].astype(np.int64),
                                  np.array([9223372036854775807, 2000, 2000, 2000]))
    np.testing.assert_array_equal(run_test(def_data, zero_to_nan, elapsed_on_tick)['val1'].astype(np.int64),
                                  np.array([0, 200, 300, 0, 500, 600, 0, 800, 0, 1000]))
    np.testing.assert_array_equal(run_test(def_data, zero_to_nan, elapsed_on_time)['val1'].astype(np.int64),
                                  np.array([1500, 900, 1500, 2000]))

    sum_tw_tick_clean = run_test(def_data, zero_ident, sum_tw_on_tick)
    np.testing.assert_array_almost_equal(sum_tw_tick_clean['val1'],
                                         np.array([0.000e+00, 6.460e-06, 3.960e-06, 0.000e+00, 1.140e-05, 1.368e-05,
                                                   0.000e+00, 2.600e-06, 0.000e+00, 9.830e-05]))
    np.testing.assert_array_almost_equal(sum_tw_tick_clean['val2'],
                                         np.array([0.000e+00, 4.320e-06, 6.450e-06, 1.212e-05, 1.515e-05, 1.818e-05,
                                                   1.435e-05, 1.640e-05, 5.877e-05, 6.530e-05]))

    sum_tw_tick_nan = run_test(def_data, zero_to_nan, sum_tw_on_tick)
    np.testing.assert_array_almost_equal(sum_tw_tick_nan['val1'],
                                         np.array([0.000e+00, 6.460e-06, 3.960e-06, 0.000e+00, 1.140e-05, 1.368e-05,
                                                   0.000e+00, 2.600e-06, 0.000e+00, 9.830e-05]))
    np.testing.assert_array_almost_equal(sum_tw_tick_nan['val2'],
                                         np.array([0.000e+00, 4.320e-06, 6.450e-06, 1.212e-05, 1.515e-05, 1.818e-05,
                                                   1.435e-05, 1.640e-05, 5.877e-05, 6.530e-05]))

    sum_tw_time_clean = run_test(def_data, zero_ident, sum_tw_on_time)
    np.testing.assert_array_almost_equal(sum_tw_time_clean['val1'],
                                         np.array([3.3220e-05, 4.8800e-06, 1.2575e-04, 1.0980e-04]))
    np.testing.assert_array_almost_equal(sum_tw_time_clean['val2'],
                                         np.array([5.3190e-05, 5.9900e-05, 1.3065e-04, 1.3080e-04]))

    sum_tw_time_nan = run_test(def_data, zero_to_nan, sum_tw_on_time)
    np.testing.assert_array_almost_equal(sum_tw_time_nan['val1'],
                                         np.array([3.3220e-05, 4.8800e-06, 1.2575e-04, 1.0980e-04]))
    np.testing.assert_array_almost_equal(sum_tw_time_nan['val2'],
                                         np.array([5.3190e-05, 5.9900e-05, 1.3065e-04, 1.3080e-04]))

    unique_clean = run_test(def_data, zero_ident, unique)
    np.testing.assert_array_almost_equal(unique_clean['val1'],
                                         np.array([32.3, 13.2, 0., 22.8, 0., 3.25, 0., 98.3, 54.9]))
    np.testing.assert_array_almost_equal(unique_clean['val2'],
                                         np.array([21.6, 21.5, 30.3, 30.3, 20.5, 20.5, 65.3, 65.3, 65.4]))

    unique_nan = run_test(def_data, zero_to_nan, unique)
    np.testing.assert_array_almost_equal(unique_nan['val1'],
                                         np.array([32.3, 13.2, np.NaN, 22.8, np.NaN, 3.25, np.NaN, 98.3, 54.9]))
    np.testing.assert_array_almost_equal(unique_nan['val2'],
                                         np.array([21.6, 21.5, 30.3, 30.3, 20.5, 20.5, 65.3, 65.3, 65.4]))

    delta_tick_clean = run_test(def_data, zero_ident, delta_on_tick)
    np.testing.assert_array_almost_equal(delta_tick_clean['val1'],
                                         np.array([32.3, -19.1, -13.2, 22.8, 0., -22.8, 3.25, -3.25, 98.3, -43.4]))
    np.testing.assert_array_almost_equal(delta_tick_clean['val2'],
                                         np.array([21.6, -0.1, 8.8, 0., 0., -9.8, 0., 44.8, 0., 0.1]))

    delta_tick_nan = run_test(def_data, zero_to_nan, delta_on_tick)
    np.testing.assert_array_almost_equal(delta_tick_nan['val1'], np.array(
        [np.NaN, -19.1, np.NaN, np.NaN, 0, np.NaN, np.NaN, np.NaN, np.NaN, -43.4]))
    np.testing.assert_array_almost_equal(delta_tick_nan['val2'],
                                         np.array([np.NaN, -0.1, 8.8, 0., 0., -9.8, 0., 44.8, 0., 0.1]))

    cumulative_clean = run_test(def_data, zero_ident, cumulative)
    np.testing.assert_array_almost_equal(cumulative_clean['val1'],
                                         np.array([32.3, 45.5, 45.5, 68.3, 91.1, 91.1, 94.35, 94.35, 192.65, 247.55]))
    np.testing.assert_array_almost_equal(cumulative_clean['val2'],
                                         np.array([21.6, 43.1, 73.4, 103.7, 134., 154.5, 175., 240.3, 305.6, 371.]))

    cumulative_nan = run_test(def_data, zero_to_nan, cumulative)
    np.testing.assert_array_almost_equal(cumulative_nan['val1'],
                                         np.array([32.3, 45.5, 45.5, 68.3, 91.1, 91.1, 94.35, 94.35, 192.65, 247.55]))
    np.testing.assert_array_almost_equal(cumulative_nan['val2'],
                                         np.array([21.6, 43.1, 73.4, 103.7, 134., 154.5, 175., 240.3, 305.6, 371.]))

    # sma
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  sma_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   15.16666667,
                                                   17.075,
                                                   18.22,
                                                   15.18333333,
                                                   13.47857143,
                                                   11.79375,
                                                   21.40555556,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   24.755,
                                                   22.485,
                                                   21.49,
                                                   21.58,
                                                   19.75,
                                                   26.37,
                                                   35.77,
                                                   36.445,
                                                   45.665,
                                                   36.189]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  sma_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   22.75,
                                                   22.76666667,
                                                   22.775,
                                                   22.775,
                                                   18.87,
                                                   18.87,
                                                   32.10833333,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   35.36428571,
                                                   32.12142857,
                                                   30.7,
                                                   26.975,
                                                   24.6875,
                                                   32.9625,
                                                   39.74444444,
                                                   40.49444444,
                                                   45.665,
                                                   36.189]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  sma_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   15.5,
                                                   17.325,
                                                   18.42,
                                                   15.51666667,
                                                   13.76428571,
                                                   12.16875,
                                                   21.73888889,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   25.055,
                                                   22.785,
                                                   21.79,
                                                   21.78,
                                                   19.95,
                                                   26.57,
                                                   35.87,
                                                   36.545,
                                                   45.665,
                                                   36.189]))

    # stdev

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  stdev_tick_mw)['val1'],
                                         np.array([0,
                                                   13.50573952,
                                                   16.23956075,
                                                   13.79791651,
                                                   12.22055645,
                                                   13.22125813,
                                                   12.88454685,
                                                   12.84541156,
                                                   31.23876242,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.29886801,
                                                   31.51329569,
                                                   31.99247134,
                                                   31.92649718,
                                                   32.37018518,
                                                   39.12725109,
                                                   43.17061243,
                                                   42.65533997,
                                                   43.85025054,
                                                   41.38132548]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  stdev_tick_mw)['val1'],
                                         np.array([0,
                                                   13.50573952,
                                                   13.50573952,
                                                   9.55004363,
                                                   7.797595783,
                                                   7.797595783,
                                                   11.03843286,
                                                   11.03843286,
                                                   33.89687916,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   32.12020022,
                                                   33.59325152,
                                                   34.71895496,
                                                   33.8261733,
                                                   34.75486348,
                                                   41.47294083,
                                                   43.80590317,
                                                   43.1559414,
                                                   43.85025054,
                                                   41.38132548]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  stdev_tick_mw)['val1'],
                                         np.array([0,
                                                   13.50573952,
                                                   15.77624797,
                                                   13.38839672,
                                                   11.85040084,
                                                   12.7640772,
                                                   12.54049156,
                                                   12.45646526,
                                                   30.98477225,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.03786621,
                                                   31.27828542,
                                                   31.7714477,
                                                   31.77873328,
                                                   32.23707321,
                                                   38.97947608,
                                                   43.07961106,
                                                   42.56147482,
                                                   43.85025054,
                                                   41.38132548]))

    # median

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  median_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   8.225,
                                                   13.2,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   11.4,
                                                   6.425,
                                                   6.425,
                                                   3.875,
                                                   3.875,
                                                   7.05,
                                                   9.8,
                                                   32.45,
                                                   9.8]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  median_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   22.75,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   16.2,
                                                   7.05,
                                                   7.05,
                                                   9.6,
                                                   10,
                                                   32.45,
                                                   9.8]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  median_tick_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   8.225,
                                                   13.2,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   18,
                                                   11.4,
                                                   6.425,
                                                   6.425,
                                                   3.875,
                                                   3.875,
                                                   7.05,
                                                   9.8,
                                                   32.45,
                                                   9.8]))

    # percentile

    np.testing.assert_array_almost_equal(run_test(def_avg_data, zero_ident, percentile_tick_mw)['val1_0'], np.array(
        [32.3, 13.2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.9, 0.9]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_tick_mw)['val1_50'],
                                         np.array([32.3,
                                                   32.3,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   9.6,
                                                   9.6,
                                                   4.5,
                                                   4.5,
                                                   9.6,
                                                   10,
                                                   54.9,
                                                   10]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_tick_mw)['val1_95'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_tick_mw)['val1_100'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_tick_mw)['val1_0'],
                                         np.array([32.3,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_tick_mw)['val1_50'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   9.6,
                                                   9.6,
                                                   9.6,
                                                   10,
                                                   54.9,
                                                   10]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_tick_mw)['val1_95'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_tick_mw)['val1_100'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94]))

    # sma_time_mw
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  sma_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   15.16666667,
                                                   17.075,
                                                   18.22,
                                                   15.18333333,
                                                   13.47857143,
                                                   11.79375,
                                                   21.40555556,
                                                   24.755,
                                                   25.44090909,
                                                   24.42083333,
                                                   22.54230769,
                                                   22.56071429,
                                                   22.57666667,
                                                   21.165625,
                                                   20.11176471,
                                                   18.99444444,
                                                   23.16842105,
                                                   24.755,
                                                   23.62,
                                                   23.1225,
                                                   23.1675,
                                                   22.2525,
                                                   25.5625,
                                                   30.2625,
                                                   30.6,
                                                   35.21,
                                                   30.472,
                                                   29.18631579,
                                                   29.01333333,
                                                   29.94352941,
                                                   31.815,
                                                   32.416,
                                                   33.10285714,
                                                   35.64923077,
                                                   38.34916667,
                                                   41.83545455,
                                                   36.189,
                                                   34.11,
                                                   37.17375,
                                                   42.02,
                                                   48.87333333,
                                                   57.748,
                                                   49.935,
                                                   35.24666667,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  sma_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   22.75,
                                                   22.76666667,
                                                   22.775,
                                                   22.775,
                                                   18.87,
                                                   18.87,
                                                   32.10833333,
                                                   35.36428571,
                                                   34.98125,
                                                   32.56111111,
                                                   32.56111111,
                                                   31.585,
                                                   30.78636364,
                                                   30.78636364,
                                                   28.49166667,
                                                   28.49166667,
                                                   33.86153846,
                                                   35.36428571,
                                                   33.74285714,
                                                   33.03214286,
                                                   30.89,
                                                   29.67,
                                                   34.08333333,
                                                   37.828125,
                                                   38.25,
                                                   41.42352941,
                                                   35.84941176,
                                                   34.65875,
                                                   34.816,
                                                   36.36,
                                                   36.36,
                                                   37.40307692,
                                                   38.62,
                                                   38.62,
                                                   41.83545455,
                                                   41.83545455,
                                                   36.189,
                                                   34.11,
                                                   37.17375,
                                                   42.02,
                                                   48.87333333,
                                                   57.748,
                                                   49.935,
                                                   35.24666667,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  sma_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   15.5,
                                                   17.325,
                                                   18.42,
                                                   15.51666667,
                                                   13.76428571,
                                                   12.16875,
                                                   21.73888889,
                                                   25.055,
                                                   25.71363636,
                                                   24.67083333,
                                                   22.85,
                                                   22.84642857,
                                                   22.84333333,
                                                   21.478125,
                                                   20.40588235,
                                                   19.32777778,
                                                   23.48421053,
                                                   25.055,
                                                   23.92,
                                                   23.4225,
                                                   23.4175,
                                                   22.5025,
                                                   25.8125,
                                                   30.4625,
                                                   30.8,
                                                   35.36,
                                                   30.622,
                                                   29.34421053,
                                                   29.18,
                                                   30.12,
                                                   31.94,
                                                   32.54933333,
                                                   33.24571429,
                                                   35.72615385,
                                                   38.4325,
                                                   41.83545455,
                                                   36.189,
                                                   34.11,
                                                   37.17375,
                                                   42.02,
                                                   48.87333333,
                                                   57.748,
                                                   49.935,
                                                   35.24666667,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    # stdev_time
    np.testing.assert_array_almost_equal(run_test(def_avg_data, zero_ident, stdev_time_mw)['val1'],
                                         np.array([0, 13.50573952, 16.23956075, 13.79791651, 12.22055645, 13.22125813,
                                                   12.88454685, 12.84541156, 31.23876242, 31.29886801, 29.77973151,
                                                   28.61289806, 28.21964332, 27.11264379, 26.12647034, 25.8639306,
                                                   25.4168161, 25.10945972, 30.43809387, 30.46408109, 30.59078551,
                                                   30.84898478, 30.81411704, 31.09601631, 34.49491906, 37.13172808,
                                                   36.90325545, 38.59936801, 36.18809118, 36.70743721, 37.76367177,
                                                   38.71275822, 39.18008763, 40.47883112, 41.91605942, 42.48562217,
                                                   43.19422425, 43.49574263, 41.38132548, 43.33405878, 45.27202319,
                                                   46.60412857, 47.02978914, 46.62674683, 49.9177814, 49.42868128,
                                                   62.69208722, 0, 0]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data, zero_to_nan, stdev_time_mw)['val1'],
                                         np.array([0, 13.50573952, 13.50573952, 9.55004363, 7.797595783, 7.797595783,
                                                   11.03843286, 11.03843286, 33.89687916, 32.12020022, 29.75725527,
                                                   28.76666667, 28.76666667, 27.29656114, 26.03090558, 26.03090558,
                                                   26.06136843, 26.06136843, 31.58254498, 30.86009016, 31.62045259,
                                                   32.22376457, 32.14083517, 32.81019441, 36.10679925, 37.96265256,
                                                   37.5884335, 38.67552972, 36.74640382, 37.61131335, 38.92596339,
                                                   39.91587519, 39.91587519, 41.34668918, 42.94135938, 42.94135938,
                                                   43.49574263, 43.49574263, 41.38132548, 43.33405878, 45.27202319,
                                                   46.60412857, 47.02978914, 46.62674683, 49.9177814, 49.42868128,
                                                   62.69208722, 0, 0]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data, zero_to_one, stdev_time_mw)['val1'],
                                         np.array([0, 13.50573952, 15.77624797, 13.38839672, 11.85040084, 12.7640772,
                                                   12.54049156, 12.45646526, 30.98477225, 31.03786621, 29.52602319,
                                                   28.38277693, 27.95623067, 26.85948095, 25.88244625, 25.59417231,
                                                   25.17270895, 24.84577264, 30.18708357, 30.21004059, 30.34961805,
                                                   30.61498375, 30.61884643, 30.91031796, 34.30222823, 36.96202844,
                                                   36.73056593, 38.4568131, 36.05675272, 36.57659806, 37.62980155,
                                                   38.56945991, 39.07316129, 40.36580067, 41.79596166, 42.41654719,
                                                   43.11440323, 43.49574263, 41.38132548, 43.33405878, 45.27202319,
                                                   46.60412857, 47.02978914, 46.62674683, 49.9177814, 49.42868128,
                                                   62.69208722, 0, 0]))

    # median_time
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  median_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   8.225,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   18,
                                                   13.2,
                                                   11.4,
                                                   11.4,
                                                   7.05,
                                                   7.05,
                                                   11.4,
                                                   11.6,
                                                   18,
                                                   11.6,
                                                   10,
                                                   9.8,
                                                   9.6,
                                                   9.8,
                                                   9.6,
                                                   7.05,
                                                   9.6,
                                                   9.8,
                                                   10,
                                                   9.8,
                                                   9.6,
                                                   7.25,
                                                   10,
                                                   49.5,
                                                   89,
                                                   51.1,
                                                   10,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  median_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   22.75,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   27.55,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   16.4,
                                                   16.4,
                                                   10,
                                                   9.8,
                                                   9.8,
                                                   10,
                                                   10,
                                                   9.8,
                                                   9.6,
                                                   7.25,
                                                   10,
                                                   49.5,
                                                   89,
                                                   51.1,
                                                   10,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  median_time_mw)['val1'],
                                         np.array([32.3,
                                                   22.75,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   8.225,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   18,
                                                   22.8,
                                                   18,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   18,
                                                   13.2,
                                                   11.4,
                                                   11.4,
                                                   7.05,
                                                   7.05,
                                                   11.4,
                                                   11.6,
                                                   18,
                                                   11.6,
                                                   10,
                                                   9.8,
                                                   9.6,
                                                   9.8,
                                                   9.6,
                                                   7.05,
                                                   9.6,
                                                   9.8,
                                                   10,
                                                   9.8,
                                                   9.6,
                                                   7.25,
                                                   10,
                                                   49.5,
                                                   89,
                                                   51.1,
                                                   10,
                                                   47.87,
                                                   3.54,
                                                   np.NaN]))

    # percentile_time

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_time_mw)['val1_0'],
                                         np.array([32.3,
                                                   13.2,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_time_mw)['val1_50'],
                                         np.array([32.3,
                                                   32.3,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   22.8,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   9.6,
                                                   9.6,
                                                   13.2,
                                                   13.2,
                                                   22.8,
                                                   13.2,
                                                   10,
                                                   10,
                                                   9.6,
                                                   10,
                                                   9.6,
                                                   9.6,
                                                   9.6,
                                                   10,
                                                   10,
                                                   10,
                                                   9.6,
                                                   10,
                                                   10,
                                                   89,
                                                   89,
                                                   92.2,
                                                   10,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_time_mw)['val1_95'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   92.2,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  percentile_time_mw)['val1_100'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   92.2,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_time_mw)['val1_0'],
                                         np.array([32.3,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   13.2,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   3.25,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   0.9,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_time_mw)['val1_50'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   32.3,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   22.8,
                                                   13.2,
                                                   22.8,
                                                   22.8,
                                                   10,
                                                   10,
                                                   10,
                                                   10,
                                                   10,
                                                   10,
                                                   9.6,
                                                   10,
                                                   10,
                                                   89,
                                                   89,
                                                   92.2,
                                                   10,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_time_mw)['val1_95'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   92.2,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  percentile_time_mw)['val1_100'],
                                         np.array([32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   32.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   98.3,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   94,
                                                   92.2,
                                                   92.2,
                                                   3.54,
                                                   np.NaN]))
    # ema_exp
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  ema_exp)['val1'],
                                         np.array([32.3,
                                                   31.36848201,
                                                   29.83862309,
                                                   29.49534539,
                                                   29.16880954,
                                                   27.74622991,
                                                   26.55153468,
                                                   25.25660106,
                                                   28.81896966,
                                                   30.09095652,
                                                   30.19869284,
                                                   29.36965681,
                                                   27.93728174,
                                                   27.68673356,
                                                   27.44840475,
                                                   26.10973025,
                                                   24.99484805,
                                                   23.77583493,
                                                   27.41042135,
                                                   28.75110392,
                                                   27.81709356,
                                                   26.61894227,
                                                   25.36461465,
                                                   24.34703539,
                                                   27.50019768,
                                                   30.74343131,
                                                   29.73176223,
                                                   32.77837413,
                                                   31.3524018]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  ema_exp)['val1'],
                                         np.array([32.3,
                                                   31.36848201,
                                                   31.36848201,
                                                   30.55308314,
                                                   30.17496081,
                                                   30.17496081,
                                                   27.61271202,
                                                   27.61271202,
                                                   34.33949686,
                                                   35.34224443,
                                                   35.19387242,
                                                   34.1212186,
                                                   34.1212186,
                                                   33.04386221,
                                                   32.54426315,
                                                   32.54426315,
                                                   29.75654543,
                                                   29.75654543,
                                                   36.27931755,
                                                   37.18745895,
                                                   35.8420027,
                                                   34.25247197,
                                                   32.62585272,
                                                   31.25413869,
                                                   34.07043758,
                                                   36.99323683,
                                                   35.67676114,
                                                   38.43343202,
                                                   36.73165926]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  ema_exp)['val1'],
                                         np.array([32.3,
                                                   31.36848201,
                                                   29.88739366,
                                                   29.5417374,
                                                   29.21293898,
                                                   27.83697771,
                                                   26.63785666,
                                                   25.38748364,
                                                   28.94346902,
                                                   30.20938397,
                                                   30.31134452,
                                                   29.4768144,
                                                   28.08798377,
                                                   27.83008576,
                                                   27.58476558,
                                                   26.28821127,
                                                   25.16462445,
                                                   23.9861018,
                                                   27.61043339,
                                                   28.94136126,
                                                   27.99807194,
                                                   26.79109423,
                                                   25.52837066,
                                                   24.50280492,
                                                   27.64837024,
                                                   30.88437741,
                                                   29.86583431,
                                                   32.90590744,
                                                   31.47371523]))

    # stdev_exp
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  stdev_exp)['val1'],
                                         np.array([0,
                                                   4.113911506,
                                                   7.857973358,
                                                   7.812466638,
                                                   7.754842701,
                                                   9.832388423,
                                                   10.94528013,
                                                   12.11041309,
                                                   19.67298531,
                                                   19.99268942,
                                                   19.50487237,
                                                   19.37242872,
                                                   19.92497183,
                                                   19.46449913,
                                                   19.01307516,
                                                   19.46327411,
                                                   19.61088372,
                                                   19.86990935,
                                                   25.16371049,
                                                   25.24653571,
                                                   24.96631253,
                                                   24.91820163,
                                                   24.92631031,
                                                   24.72275667,
                                                   27.84464513,
                                                   30.70288395,
                                                   30.2763056,
                                                   32.44970781,
                                                   32.26900431]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  stdev_exp)['val1'],
                                         np.array([0,
                                                   4.113911506,
                                                   4.113911506,
                                                   4.651404744,
                                                   4.834151882,
                                                   4.834151882,
                                                   9.141580668,
                                                   9.141580668,
                                                   22.4914305,
                                                   22.37866479,
                                                   21.8359675,
                                                   21.8173424,
                                                   21.8173424,
                                                   21.01750866,
                                                   20.61698795,
                                                   20.61698795,
                                                   21.41268627,
                                                   21.41268627,
                                                   28.62547064,
                                                   28.20531146,
                                                   28.14334979,
                                                   28.33194091,
                                                   28.55094871,
                                                   28.49736899,
                                                   30.44981968,
                                                   32.38195762,
                                                   32.11313775,
                                                   33.60320694,
                                                   33.62424182]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  stdev_exp)['val1'],
                                         np.array([0,
                                                   4.113911506,
                                                   7.673567857,
                                                   7.638205172,
                                                   7.58981955,
                                                   9.577189366,
                                                   10.73750742,
                                                   11.83911143,
                                                   19.49254892,
                                                   19.8162772,
                                                   19.33225648,
                                                   19.21177519,
                                                   19.71578259,
                                                   19.26270023,
                                                   18.81831604,
                                                   19.2261666,
                                                   19.39692353,
                                                   19.62092789,
                                                   24.94809621,
                                                   25.03200767,
                                                   24.76684076,
                                                   24.73649696,
                                                   24.76187936,
                                                   24.57155164,
                                                   27.7001973,
                                                   30.56340671,
                                                   30.146283,
                                                   32.32234733,
                                                   32.15257845]))

    # ar
    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_ident,
                                                  ar)['val1'],
                                         np.array([22.61,
                                                   18.846,
                                                   7.5384,
                                                   9.06456,
                                                   11.124876,
                                                   3.55996032,
                                                   3.296494048,
                                                   0.4615091667,
                                                   15.13728279,
                                                   29.84948816,
                                                   31.80989763,
                                                   19.15516724,
                                                   12.64241038,
                                                   14.16604882,
                                                   14.68408589,
                                                   4.741148986,
                                                   54.32734002,
                                                   54.52204442,
                                                   16.33830666,
                                                   13.72064533,
                                                   6.028258132,
                                                   61.22784311,
                                                   58.15417252,
                                                   88.79541725,
                                                   24.85385431]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_nan,
                                                  ar)['val1'],
                                         np.array([32.3,
                                                   24.66,
                                                   24.66,
                                                   24.474,
                                                   24.2229,
                                                   24.2229,
                                                   6.395935,
                                                   6.395935,
                                                   20.18154475,
                                                   33.02737319,
                                                   32.44547464,
                                                   19.35855188,
                                                   19.35855188,
                                                   19.8747691,
                                                   20.05028296,
                                                   19.04226598,
                                                   61.04886501,
                                                   58.95825091,
                                                   17.00373764,
                                                   14.25299011,
                                                   6.241196044,
                                                   61.25680266,
                                                   58.1813945,
                                                   88.79813945,
                                                   24.85453486]))

    np.testing.assert_array_almost_equal(run_test(def_avg_data,
                                                  zero_to_one,
                                                  ar)['val1'],
                                         np.array([22.91,
                                                   19.026,
                                                   8.2104,
                                                   9.66936,
                                                   11.638956,
                                                   4.50446592,
                                                   3.438169888,
                                                   1.341343784,
                                                   15.88514222,
                                                   30.3206396,
                                                   31.90412792,
                                                   19.18532093,
                                                   13.00231182,
                                                   14.47196504,
                                                   14.97164714,
                                                   5.492925069,
                                                   54.68067478,
                                                   54.75524536,
                                                   16.3732868,
                                                   13.74862944,
                                                   6.039451777,
                                                   61.22936544,
                                                   58.15560352,
                                                   88.79556035,
                                                   24.85389009]))
